---
ansible_host: 192.168.5.149
target_os: ubuntu

appdata_path: /mnt/appdata

### mrlesmithjr.zfs
zfs_pools:
  - name: data1
    action: 'create'
    compression: 'lz4'
    devices:
      - 'ata-ST2000LX001-1RG174_WCC2V2L7'
    type: 'basic'
    state: 'present'

zfs_filesystems:
  - name: appdata
    pool: data1
    compression: lz4
    mountpoint: "{{ appdata_path }}"
    state: present

### exterrestris.sanoid
sanoid_datasets:
  - name: data1/appdata
    templates: frequent

syncoid_syncs:
  - src: data1/appdata
    dest: backup2/backups/argus-array/appdata
    dest_host: "memory-beta.{{ internal_domain }}"

### exterrestris.docker_compose
docker_compose_projects:
  - project_dir: "{{ appdata_path }}/monitoring"
    containers:
      - service_name: uptime-kuma
        container_name: uptime-kuma
        image:
          name: louislam/uptime-kuma
        environment:
          - PUID={{ (container_users | selectattr('username', 'equalto', 'uptime-kuma') | list | first).uid }}
          - PGID={{ (container_users | selectattr('username', 'equalto', 'uptime-kuma') | list | first).gid }}
        volumes:
          - source: uptime-kuma
            target: /app/data
            group: uptime-kuma
            owner: uptime-kuma
            mode: "755"
        expose:
          - 3001
        networks:
          - proxy
        restart: always
        labels:
          - "traefik.enable=true"
          ## Router
          - "traefik.http.routers.uptime-kuma.entryPoints=https"
          - "traefik.http.routers.uptime-kuma.rule=Host(`uptime.{{ internal_domain }}`,`status.{{ internal_domain }}`)"
          - "traefik.http.routers.uptime-kuma.tls=true"
          ## Service
          - "traefik.http.services.uptime-kuma-svc.loadBalancer.server.port=3001"
          - "traefik.http.services.uptime-kuma-svc.loadbalancer.server.scheme=http"
          - "traefik.http.services.uptime-kuma-svc.loadBalancer.passHostHeader=true"
    networks:
      - name: proxy
        external: true
        alias: "{{ traefik_docker_network }}"
  - project_dir: "{{ appdata_path }}/network"
    containers:
      - service_name: omada-controller
        container_name: omada-controller
        image:
          name: mbentley/omada-controller
        ports:
          - port: 8088
          - port: 8043
          - port: 8843
          - port: 27001
            protocol: udp
          - port: 29810
            protocol: udp
          - port: 29811
          - port: 29812
          - port: 29813
          - port: 29814
        environment:
          - PUID={{ (container_users | selectattr('username', 'equalto', 'omada') | list | first).uid }}
          - PGID={{ (container_users | selectattr('username', 'equalto', 'omada') | list | first).gid }}
          - MANAGE_HTTP_PORT=8088
          - MANAGE_HTTPS_PORT=8043
          - PORTAL_HTTP_PORT=8088
          - PORTAL_HTTPS_PORT=8843
          - PORT_APP_DISCOVERY=27001
          - PORT_ADOPT_V1=29812
          - PORT_UPGRADE_V1=29813
          - PORT_MANAGER_V1=29811
          - PORT_MANAGER_V2=29814
          - PORT_DISCOVERY=29810
          - SHOW_SERVER_LOGS=true
          - SHOW_MONGODB_LOGS=false
          #- SSL_CERT_NAME=tls.crt
          #- SSL_KEY_NAME=tls.key
          - TZ=Etc/UTC
        volumes:
          - source: omada-controller/data
            target: /opt/tplink/EAPController/data
            group: omada
            owner: omada
            mode: "755"
          - source: omada-controller/logs
            target: /opt/tplink/EAPController/logs
            group: omada
            owner: omada
            mode: "755"
        restart: always
